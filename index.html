
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML –≤–µ—Ä—Å–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è</title>
    <link rel="icon" href="icon16.png">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
    </style>
</head>
<body>
    <h1>HTML –≤–µ—Ä—Å–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –±–µ–∑ Chrome API –∏ VK API</h1>
    <h2>–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å:</h2>
    
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1e1e2f;
      color: #f0f0f0;
      margin: 0;
      padding: 20px;
      width: 280px;
    }

    h3 {
      margin-bottom: 10px;
      font-size: 18px;
      text-align: center;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: none;
      margin-bottom: 12px;
      font-size: 16px;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 12px;
      border: none;
      background-color: #4CAF50;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }

    button:hover {
      background-color: #45a049;
    }

    #statusContainer {
      margin-top: 15px;
      font-weight: bold;
      font-size: 20px;
      text-align: center;
    }

    #userInfo {
      text-align: center;
      margin-top: 15px;
    }

    #userInfo img {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      margin-bottom: 8px;
    }

    #userInfo div {
      font-size: 18px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h3>–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω VK</h3>
  <input type="text" id="tokenInput" placeholder="vk1.a....">
  <button id="saveToken">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <div id="statusContainer"></div>
  <div id="userInfo"></div>
  <script src="popup.js"></script>
</body>
</html>


    <script>
    // –ó–∞–≥–ª—É—à–∫–∞ chrome.storage.local
    
document.addEventListener("DOMContentLoaded", async () => {
  const statusContainer = document.getElementById("statusContainer");
  const userInfo = document.getElementById("userInfo");

  function fakeStorageGet(key, callback) { callback({ [key]: JSON.parse(localStorage.getItem(key)) }); }("vkToken", async (result) => {
    const token = result.vkToken;
    if (token) {
      try {
        const response = await fetch(`https://api.vk.com/method/users.get?access_token=${token}&v=5.131&fields=photo_100`);
        const data = await response.json();
        if (data.response && data.response[0]) {
          const user = data.response[0];
          statusContainer.innerText = ""; // –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å "—Ç–æ–∫–µ–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"
          userInfo.innerHTML = `
            <img src="${user.photo_100}" id="userAvatar">
            <div>${user.first_name} ${user.last_name}</div>
          `;
        }
      } catch (e) {
        statusContainer.style.color = "red";
        statusContainer.innerText = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö.";
      }
    }
  });
});

document.getElementById("saveToken").addEventListener("click", async () => {
  const tokenInput = document.getElementById("tokenInput");
  const statusContainer = document.getElementById("statusContainer");
  const userInfo = document.getElementById("userInfo");

  const token = tokenInput.value.trim();
  statusContainer.style.color = "red";
  userInfo.innerHTML = "";

  if (!token) {
    statusContainer.innerText = "‚õî –¢–æ–∫–µ–Ω –Ω–µ –≤–≤–µ–¥—ë–Ω.";
    return;
  }

  try {
    const response = await fetch(`https://api.vk.com/method/users.get?access_token=${token}&v=5.131&fields=photo_100`);
    const data = await response.json();

    if (data.response && data.response[0]) {
      const user = data.response[0];
      function fakeStorageSet(obj, callback) { for (const k in obj) { localStorage.setItem(k, JSON.stringify(obj[k])); } if(callback) callback(); }({ vkToken: token }, () => {
        statusContainer.style.color = "lightgreen";
        statusContainer.innerText = "‚úÖ –¢–æ–∫–µ–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.";
        userInfo.innerHTML = `
          <img src="${user.photo_100}" id="userAvatar">
          <div>${user.first_name} ${user.last_name}</div>
        `;
        tokenInput.value = ""; // –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ
      });
    } else {
      statusContainer.innerText = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω.";
    }
  } catch (e) {
    statusContainer.innerText = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–∞.";
  }
});


    // –ö–æ–Ω—Ç–µ–Ω—Ç-—Å–∫—Ä–∏–ø—Ç –æ—á–∏—â–µ–Ω–Ω—ã–π
    async function getMessageHistory(userId, token) {
  await new Promise(resolve => setTimeout(resolve, 350)); // –∑–∞–º–µ–¥–ª—è–µ–º –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å
  const url = `https://api.vk.com/method/messages.getHistory?user_id=${userId}&count=20&access_token=${token}&v=5.199`;
  try {
    const resp = await fetch(url);
    const data = await resp.json();
    return data;
  } catch (e) {
    return null;
  }
}

async function getToken() {
  return new Promise(resolve => {
    chrome.storage.local.get("vkToken", data => {
      resolve(data.vkToken);
    });
  });
}

async function getUserIdAndMessagePermission(username, token) {
  const cacheKey = "userInfo:" + username;
  const cached = localStorage.getItem(cacheKey);
  if (cached) return JSON.parse(cached);

  const url = `https://api.vk.com/method/users.get?user_ids=${username}&fields=can_write_private_message&access_token=${token}&v=5.199`;
  try {
    const resp = await fetch(url);
    const data = await resp.json();
    if (data.response && data.response.length > 0) {
      const info = {
        id: data.response[0].id,
        can_message: data.response[0].can_write_private_message === 1
      };
      localStorage.setItem(cacheKey, JSON.stringify(info));
      return info;
    }
  } catch (e) {}
  return { id: null, can_message: false };
}

async function getAllConversations(token) {
  const url = `https://api.vk.com/method/messages.getConversations?access_token=${token}&v=5.199&count=1000&extended=1`;
  try {
    const resp = await fetch(url);
    const data = await resp.json();
    const ids = new Set();
    if (data.response && data.response.items) {
      for (const item of data.response.items) {
        const peer = item.conversation.peer;
        if (peer && peer.type === "user") {
          ids.add(peer.id);
        }
      }
    }
    return ids;
  } catch (e) {}
  return new Set();
}

async function hasConversationWithUser(userId, token, username, knownConversations) {
  const cached = localStorage.getItem("chat:" + userId);
  if (cached !== null) return cached === "true";

  if (knownConversations.has(userId)) {
    localStorage.setItem("chat:" + userId, "true");
    return true;
  }

  const historyUrl = `https://api.vk.com/method/messages.getHistory?access_token=${token}&v=5.199&user_id=${userId}&count=1`;
  try {
    const historyResp = await fetch(historyUrl);
    const historyData = await historyResp.json();
    if (historyData.response && historyData.response.items && historyData.response.items.length > 0) {
      localStorage.setItem("chat:" + userId, "true");
      return true;
    }
  } catch (e) {}

  return false;
}

function extractUsernameFromBlock(block) {
  const link = block.querySelector('a[href*="vk.com/"], a[href^="/"]');
  if (link) {
    const match = link.href.match(/(?:vk\.com\/|\/)(id\d+|[a-zA-Z0-9_\.]+)(?=\?|$)/);
    if (match) return match[1];
  }
  return null;
}

const processedElements = new WeakSet();

async function processUsers() {
  if (location.pathname.startsWith("/im")) return;
  const token = await getToken();
  if (!token) return;

  const knownConversations = await getAllConversations(token);
  const elements = [];

  document.querySelectorAll("div").forEach(block => {
    if (processedElements.has(block)) return;

    const button = block.querySelector("button");
    const username = extractUsernameFromBlock(block);

    if (username && button) {
      elements.push({ block, button, username });
      processedElements.add(block);
    }
  });

  for (const { block, button, username } of elements) {
    const existing = block.querySelector(`.chat-status[data-uid="${username}"]`);
    const sendButtonExists = block.querySelector('button.send-button');
    if (sendButtonExists) continue;
    if (existing) continue;

    const userInfo = await getUserIdAndMessagePermission(username, token);
    if (!userInfo.id) continue;

    const container = document.createElement("span");
    container.style.display = "inline-flex";
    container.style.alignItems = "center";

    const badge = document.createElement("span");
    badge.className = "chat-status";
    badge.dataset.uid = username;
    badge.style.fontSize = "12px";
    badge.style.marginRight = "10px";
    badge.style.verticalAlign = "middle";
    badge.style.display = "inline-block";

    if (!userInfo.can_message) {
      badge.textContent = "‚ùå –ù–µ–ª—å–∑—è –Ω–∞–ø–∏—Å–∞—Ç—å";
      badge.style.color = "#c00";
      container.prepend(badge);
      button.parentElement.insertBefore(container, button);
      continue;
    } 

    const hasDialog = await hasConversationWithUser(userInfo.id, token, username, knownConversations);

    try {
      const data = await getMessageHistory(userInfo.id, token);
      if (!data || !data.response || !data.response.items) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å", –ë–ï–ó –∑–Ω–∞—á–∫–∞ üí¨
        badge.remove();
        const sendBtn = document.createElement("button");
        sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
        sendBtn.className = "send-button";
        sendBtn.style.marginLeft = "5px";
        sendBtn.style.fontSize = "12px";
        sendBtn.style.cursor = "pointer";
        sendBtn.onclick = async () => {
          sendBtn.disabled = true;
          sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...";
          const url = `https://api.vk.com/method/messages.send?user_id=${userInfo.id}&random_id=${Date.now()}&message=${encodeURIComponent("–ü—Ä–∏–≤–µ—Ç, —á–µ–º –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è?")}&access_token=${token}&v=5.199`;
          try {
            const resp = await fetch(url, { method: "POST" });
            const data = await resp.json();
            sendBtn.textContent = data.response ? "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ" : "–û—à–∏–±–∫–∞ ‚ùå";
          } catch {
            sendBtn.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
          }
        };
        container.appendChild(sendBtn);
        button.parentElement.insertBefore(container, button);
        continue;
      }

      const count = data.response.items.length;
      const hasReply = data.response.items.some(msg => msg.out === 0);
      const isOnlyOneMessage = count === 1;

      if (count === 0) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å", –ë–ï–ó –∑–Ω–∞—á–∫–∞ üí¨
        badge.remove();
        const sendBtn = document.createElement("button");
        sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
        sendBtn.className = "send-button";
        sendBtn.style.marginLeft = "5px";
        sendBtn.style.fontSize = "12px";
        sendBtn.style.cursor = "pointer";
        sendBtn.onclick = async () => {
          sendBtn.disabled = true;
          sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...";
          const url = `https://api.vk.com/method/messages.send?user_id=${userInfo.id}&random_id=${Date.now()}&message=${encodeURIComponent("–ü—Ä–∏–≤–µ—Ç, —á–µ–º –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è?")}&access_token=${token}&v=5.199`;
          try {
            const resp = await fetch(url, { method: "POST" });
            const data = await resp.json();
            sendBtn.textContent = data.response ? "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ" : "–û—à–∏–±–∫–∞ ‚ùå";
          } catch {
            sendBtn.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
          }
        };
        container.appendChild(sendBtn);
      } else if (isOnlyOneMessage || !hasReply) {
        badge.textContent = `‚õî –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ (${count})`;
        badge.style.color = "#a60";
        container.prepend(badge);
        // –¢–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º üí¨
        const link = document.createElement("a");
        link.href = `https://vk.com/im?sel=${userInfo.id}`;
        link.textContent = "üí¨";
        link.target = "_blank";
        link.style.marginLeft = "5px";
        link.title = "–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ";
        container.appendChild(link);
      } else {
        badge.textContent = `‚úÖ –ï—Å—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫–∞ (${count})`;
        badge.style.color = "#0a0";
        container.prepend(badge);
        // –¢–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º üí¨
        const link = document.createElement("a");
        link.href = `https://vk.com/im?sel=${userInfo.id}`;
        link.textContent = "üí¨";
        link.target = "_blank";
        link.style.marginLeft = "5px";
        link.title = "–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ";
        container.appendChild(link);
      }
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:", e);
      badge.textContent = "‚úÖ –ï—Å—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫–∞";
      badge.style.color = "#0a0";
      container.prepend(badge);
      // –î–æ–±–∞–≤–ª—è–µ–º üí¨ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∞ –µ—Å—Ç—å!
      const link = document.createElement("a");
      link.href = `https://vk.com/im?sel=${userInfo.id}`;
      link.textContent = "üí¨";
      link.target = "_blank";
      link.style.marginLeft = "5px";
      link.title = "–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ";
      container.appendChild(link);
    }
    button.parentElement.insertBefore(container, button);
  }
}

setInterval(() => {
  processUsers();
}, 10000);

function appendSendButton(cell, userId, token) {
  const sendBtn = document.createElement("button");
  sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
  sendBtn.style.marginTop = "4px";
  sendBtn.style.fontSize = "12px";
  sendBtn.style.cursor = "pointer";
  sendBtn.onclick = async () => {
    sendBtn.disabled = true;
    sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è...";
    const url = `https://api.vk.com/method/messages.send?user_id=${userId}&random_id=${Date.now()}&message=${encodeURIComponent("–ü—Ä–∏–≤–µ—Ç, —á–µ–º –∑–∞–Ω–∏–º–∞–µ—à—å—Å—è?")}&access_token=${token}&v=5.199`;
    try {
      const resp = await fetch(url, { method: "POST" });
      const data = await resp.json();
      sendBtn.textContent = data.response ? "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ" : "–û—à–∏–±–∫–∞ ‚ùå";
    } catch {
      sendBtn.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
    }
  };
  cell.appendChild(sendBtn);
}

function extractUsernameFromElement(el) {
  const href = el.querySelector("a")?.href || "";
  const match = href.match(/vk\.com\/(id\d+|[a-zA-Z0-9_\.]+)/);
  return match ? match[1] : null;
}

// –ù–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–∏–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äî –∑–∞–º–µ–Ω–∞ "‚ùå –ù–µ—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å"
function processVisibleUsers() {
  getToken().then(async token => {
    const cards = document.querySelectorAll(".vkuiSimpleCell__host, .SimpleCell");
    for (const card of cards) {
      if (card.dataset.vkStatus === "done" || card.dataset.vkStatus === "processing") continue;
      const username = extractUsernameFromElement(card);
      if (!username) continue;

      card.dataset.vkStatus = "processing";
      const userInfo = await getUserIdAndMessagePermission(username, token);
      if (!userInfo.id) continue;
      const data = await getMessageHistory(userInfo.id, token);
      if (!data || !data.response || !data.response.items) {
        appendSendButton(card, userInfo.id, token);
        card.dataset.vkStatus = "done";
        continue;
      }
      const messages = data.response.items;
      const count = messages.length;
      const hasReply = messages.some(m => m.out === 0);
      if (count === 0) {
        appendSendButton(card, userInfo.id, token);
      } else if (count === 1 || !hasReply) {
        appendStatus(card, `‚õî –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ (${count})`, "#a60");
        // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫–∞, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å üí¨ ‚Äî –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, –≤—Å—Ç–∞–≤—å —Ç—É—Ç
      } else {
        appendStatus(card, `‚úÖ –ï—Å—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫–∞ (${count})`, "#0a0");
        // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫–∞, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å üí¨ ‚Äî –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, –≤—Å—Ç–∞–≤—å —Ç—É—Ç
      }
      card.dataset.vkStatus = "done";
    }
  });
}

function appendStatus(cell, text, color) {
  const badge = document.createElement("div");
  badge.textContent = text;
  badge.style.fontSize = "12px";
  badge.style.color = color;
  badge.style.marginTop = "4px";
  cell.appendChild(badge);
}

// MutationObserver –∏ scroll –¥–ª—è –¥–∏–Ω–∞–º–∏–∫–∏
const observer = new MutationObserver(() => {
  processVisibleUsers();
});
observer.observe(document.body, { childList: true, subtree: true });

window.addEventListener("scroll", () => {
  processVisibleUsers();
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
setInterval(processVisibleUsers, 3000);


function hideSubscribedButtons() {
  const buttons = document.querySelectorAll('.vkuiButton__content');
  buttons.forEach(btn => {
    const text = btn.textContent.trim();
    if (text === '–í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã') {
      const fullButton = btn.closest('button');
      if (fullButton) {
        fullButton.style.display = 'none';
      } else {
        btn.style.display = 'none';
      }
    }
  });
}
setInterval(hideSubscribedButtons, 1000);

    </script>
</body>
</html>
